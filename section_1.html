<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Section 1 â€“ Background</title>
		<style>
			:root {
			--bg: #f8fafc;
			--card: #ffffff;
			--border: #e5e7eb;
			--text: #111827;
			--muted: #6b7280;
			--accent: #2563eb;
			--divider: #f1f5f9;
			}
			* { box-sizing: border-box; }
			body {
			margin: 0;
			background: var(--bg);
			font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
			color: var(--text);
			}
			.container {
			max-width: 760px;
			padding: 20px 16px 60px;
			margin: auto;
			}
			h1 { font-size: 1.6rem; margin-bottom: 6px; }
			p.subtle { color: var(--muted); font-size: 0.95rem; margin-bottom: 24px; }
			.card {
			background: var(--card);
			border-radius: 14px;
			padding: 20px;
			box-shadow: 0 1px 2px rgba(0,0,0,0.04);
			margin-bottom: 20px;
			}
			.card h2 { font-size: 1.15rem; margin-bottom: 20px; color: var(--accent); }
			.field {
			padding-bottom: 24px;
			margin-bottom: 24px;
			border-bottom: 2px solid var(--divider);
			}
			.field:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
			label { display: block; font-weight: 600; margin-bottom: 8px; }
			.helper { font-size: 0.85rem; color: var(--muted); margin-top: 4px; margin-bottom: 12px; }
			select, input[type="text"] {
			width: 100%;
			padding: 12px 12px;
			border-radius: 10px;
			border: 1px solid var(--border);
			font-size: 1rem;
			background: #fff;
			}
			.checkbox-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
			.checkbox-item {
			display: flex;
			align-items: center;
			padding: 12px;
			border-radius: 10px;
			border: 1px solid var(--border);
			cursor: pointer;
			background: #fff;
			}
			.checkbox-item input { margin-right: 10px; transform: scale(1.2); }
			.checkbox-item.disabled { opacity: 0.5; cursor: not-allowed; }
			.next-area { text-align: right; margin-top: 30px; }
			#nextBtn {
			background: var(--accent);
			color: white;
			border: none;
			padding: 14px 40px;
			border-radius: 10px;
			font-weight: 600;
			cursor: pointer;
			}
			.missing-field {
			border: 2px solid #ef4444 !important; /* Red border */
			background-color: #fef2f2 !important; /* Light red tint */
			padding: 10px;
			border-radius: 8px;
			}
			.modal-overlay {
			display: none; /* Hidden by default */
			position: fixed;
			top: 0; left: 0; width: 100%; height: 100%;
			background: rgba(0, 0, 0, 0.5); /* Dim the background */
			z-index: 1000;
			align-items: center;
			justify-content: center;
			}
			.modal-box {
			background: white;
			padding: 25px;
			border-radius: 12px;
			max-width: 400px;
			width: 90%;
			text-align: center;
			box-shadow: 0 10px 25px rgba(0,0,0,0.2);
			font-family: sans-serif;
			}
			.modal-box h3 { margin-top: 0; color: #333; }
			.modal-box p { color: #666; margin-bottom: 20px; }
			.modal-box button {
			background: #007bff;
			color: white;
			border: none;
			padding: 10px 30px;
			border-radius: 6px;
			cursor: pointer;
			font-size: 16px;
			}
			@media (min-width: 640px) { .checkbox-grid { grid-template-columns: 1fr 1fr; } }
		
			.progress-container {
				display: flex;
				justify-content: space-between;
				margin-bottom: 20px;
				gap: 10px;
			}

			.step {
				height: 12px;
				flex: 1; /* Makes them equal width */
				background-color: #dcdde1; /* Gray for incomplete */
				border-radius: 2px;
				transition: background-color 0.3s ease;
			}

			.step.active {
				background-color: #3498db; /* Blue for complete/current */
			}

			/* This hides the body until the translation is ready */
			.skiptranslate + body {
				display: block !important;
			}

			/* Hide the Google Translate top banner */
			.goog-te-banner-frame.skiptranslate {
				display: none !important;
			}

			/* Prevent page from shifting down */
			body {
				top: 0 !important;
			}

			/* Hide Google logo link */
			.goog-logo-link {
				display: none !important;
			}

			/* Hide "Powered by Google" text */
			.goog-te-gadget {
				font-size: 0 !important;
				color: transparent !important;
			}

			/* Style only the dropdown itself */
			.goog-te-gadget .goog-te-combo {
				padding: 8px;
				border-radius: 4px;
				border: 1px solid #3498db;
				color: #333;
			}

		</style>
	</head>
	<body>
		<div id="language-modal">
			<div class="modal-content">
				<p>Select your preferred language:</p>
				<div id="google_translate_element"></div>
			</div>
		</div>
		<div id="google_translate_element" style="display:none;"></div>

		<script type="text/javascript">
			function googleTranslateElementInit() {
				new google.translate.TranslateElement({
					pageLanguage: 'en',
					// autoDisplay: false is key to preventing the "original text" popups
					autoDisplay: false
				}, 'google_translate_element');
			}
		</script>

		<script type="text/javascript" src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

		<div class="progress-container">
			<div class="step active"></div>
			<div class="step"></div>
			<div class="step"></div>
			<div class="step"></div>
		</div>
		
		<div class="container">
			<div class="card">
				<h2>Basic Information</h2>
				<div class="field">
					<label>What is your age range?</label>
					<select name="ageRange">
						<option value="" data-key="">Select</option>
						<option value="18-24" data-key="18-24">18-24</option>
						<option value="25-34" data-key="25-34">25-34</option>
						<option value="35-44" data-key="35-44">35-44</option>
						<option value="45-54" data-key="45-54">45-54</option>
						<option value="55-64" data-key="55-64">55-64</option>
						<option value="65+" data-key="65+">65+</option>
						<option value="Prefer not to say" data-key="Prefer not to say">Prefer not to say</option>
					</select>
				</div>
				<div class="field">
					<label>How do you describe your gender identity?</label>
					<select name="gender">
						<option value="" data-key="">Select</option>
						<option value="Woman" data-key="Woman">Woman</option>
						<option value="Man" data-key="Man">Man</option>
						<option value="Non-binary / gender diverse" data-key="Non-binary / gender diverse">Non-binary / gender diverse</option>
						<option value="Prefer not to say" data-key="Prefer not to say">Prefer not to say</option>
					</select>
				</div>
				<div class="field">
					<label>In which world region do you reside?</label>
					<select name="region">
						<option value="" data-key="">Select</option>
						<option value="Africa" data-key="Africa">Africa</option>
						<option value="East Asia" data-key="East Asia">East Asia</option>
						<option value="South Asia" data-key="South Asia">South Asia</option>
						<option value="Southeast Asia" data-key="Southeast Asia">Southeast Asia</option>
						<option value="Europe" data-key="Europe">Europe</option>
						<option value="North America" data-key="North America">North America</option>
						<option value="Latin America / Caribbean" data-key="Latin America / Caribbean">Latin America / Caribbean</option>
						<option value="Oceania" data-key="Oceania">Oceania</option>
						<option value="Prefer not to say" data-key="Prefer not to say">Prefer not to say</option>
					</select>
				</div>
				<div class="field">
					<label>What is the highest degree you have obtained?</label>
					<select name="highestDegree">
						<option value="" data-key="">Select</option>
						<option value="Less than a bachelor's degree" data-key="Less than a bachelor's degree">Less than a bachelor's degree</option>
						<option value="Bachelor's degree (BA, BS, or equivalent)" data-key="Bachelor's degree (BA, BS, or equivalent)">Bachelor's degree (BA, BS, or equivalent)</option>
						<option value="Master's degree (MA, MS, MPH, MHS, or equivalent)" data-key="Master's degree (MA, MS, MPH, MHS, or equivalent)">Master's degree (MA, MS, MPH, MHS, or equivalent)</option>
						<option value="Doctoral degree - MD (or equivalent professional medical degree)" data-key="Doctoral degree - MD (or equivalent professional medical degree)">Doctoral degree - MD (or equivalent professional medical degree)</option>
						<option value="Doctoral degree - PhD or equivalent research doctorate (e.g., ScD, DrPH)" data-key="Doctoral degree - PhD or equivalent research doctorate (e.g., ScD, DrPH)">Doctoral degree - PhD or equivalent research doctorate (e.g., ScD, DrPH)</option>
						<option value="Other doctoral or professional degree (DDS, DVM, JD, PharmD, etc.)" data-key="Other doctoral or professional degree (DDS, DVM, JD, PharmD, etc.)">Other doctoral or professional degree (DDS, DVM, JD, PharmD, etc.)</option>
						<option value="Prefer not to say" data-key="Prefer not to say">Prefer not to say</option>
					</select>
				</div>
				<div class="field">
					<label>Which income range best reflects your household's annual income relative to your local cost of living?</label>
					<select name="incomeRange">
						<option value="" data-key="">Select</option>
						<option value="Low" data-key="Low">Low</option>
						<option value="Lower-middle" data-key="Lower-middle">Lower-middle</option>
						<option value="Middle" data-key="Middle">Middle</option>
						<option value="Upper-middle" data-key="Upper-middle">Upper-middle</option>
						<option value="High" data-key="High">High</option>
						<option value="Prefer not to say" data-key="Prefer not to say">Prefer not to say</option>
					</select>
				</div>
			</div>

			<div class="card">
				<h2>Research Background</h2>
				<div class="field">
					<label>What is your current career stage?</label>
					<select name="careerStage" onchange="handleOther(this, 'careerStageOther')">
						<option value="" data-key="">Select</option>
						<option value="Student / Trainee" data-key="Student / Trainee">Student / Trainee</option>
						<option value="Postdoctoral researcher / Fellow" data-key="Postdoctoral researcher / Fellow">Postdoctoral researcher / Fellow</option>
						<option value="Early-career researcher or faculty" data-key="Early-career researcher or faculty">Early-career researcher or faculty</option>
						<option value="Mid-career researcher or faculty" data-key="Mid-career researcher or faculty">Mid-career researcher or faculty</option>
						<option value="Senior researcher or faculty" data-key="Senior researcher or faculty">Senior researcher or faculty</option>
						<option value="Research staff / Scientist" data-key="Research staff / Scientist">Research staff / Scientist</option>
						<option value="Industry researcher" data-key="Industry researcher">Industry researcher</option>
						<option value="Other" data-key="Other">Other</option>
						<option value="Prefer not to say" data-key="Prefer not to say">Prefer not to say</option>
					</select>
				</div>
				<div class="field" id="careerStageOther" style="display:none; border-bottom: none;">
					<label>Please specify your career stage:</label>
					<input type="text" name="careerStageOtherText" placeholder="e.g., Retired/Emeritus, Independent Consultant, or Sabbatical">
				</div>

				<div class="field">
					<label>What is your primary research setting?</label>
					<select name="researchSetting" onchange="handleOther(this, 'researchSettingOther')">
						<option value="" data-key="">Select</option>
						<option value="Academic institution" data-key="Academic institution">Academic institution</option>
						<option value="Hospital or clinical setting" data-key="Hospital or clinical setting">Hospital or clinical setting</option>
						<option value="Government or public health agency" data-key="Government or public health agency">Government or public health agency</option>
						<option value="Non-profit organization" data-key="Non-profit organization">Non-profit organization</option>
						<option value="Industry" data-key="Industry">Industry</option>
						<option value="Other" data-key="Other">Other</option>
						<option value="Prefer not to say" data-key="Prefer not to say">Prefer not to say</option>
					</select>
				</div>
				<div class="field" id="researchSettingOther" style="display:none; border-bottom: none;">
					<label>Additional context on your setting:</label>
					<input type="text" name="researchSettingOtherText" placeholder="e.g., Multi-site consortium, Private Foundation, or NGO">
				</div>

				<div class="field">
					<label>Which are your primary research domains?</label>
					<div class="helper">Select up to 3</div>
					<div class="checkbox-grid limit-3" id="domainGrid">
						<div class="checkbox-item"><input type="checkbox" value="Population health" data-key="Population health">Population health</div>
						<div class="checkbox-item"><input type="checkbox" value="Public health" data-key="Public health">Public health</div>
						<div class="checkbox-item"><input type="checkbox" value="Epidemiology" data-key="Epidemiology">Epidemiology</div>
						<div class="checkbox-item"><input type="checkbox" value="Clinical research" data-key="Clinical research">Clinical research</div>
						<div class="checkbox-item"><input type="checkbox" value="Translational research" data-key="Translational research">Translational research</div>
						<div class="checkbox-item"><input type="checkbox" value="Health services research" data-key="Health services research">Health services research</div>
						<div class="checkbox-item"><input type="checkbox" value="Behavioral or social science" data-key="Behavioral or social science">Behavioral or social science</div>
						<div class="checkbox-item"><input type="checkbox" value="Biomedical informatics" data-key="Biomedical informatics">Biomedical informatics</div>
						<div class="checkbox-item"><input type="checkbox" value="Computational / Data science" data-key="Computational / Data science">Computational / Data science</div>
						<div class="checkbox-item"><input type="checkbox" value="Other" data-key="Other" onchange="handleOther(this, 'domainOtherField')">Other</div>
						<div class="checkbox-item"><input type="checkbox" value="Prefer not to say" data-key="Prefer not to say">Prefer not to say</div>
					</div>
				</div>

				<div class="field" id="domainOtherField" style="display:none; border-bottom: none;">
					<label>Please specify your research domain:</label>
					<input type="text" name="domainOtherText" placeholder="e.g., Environmental Toxins, Health Economics, or Bioethics">
				</div>

				<div class="field">
					<label>What is your primary methodological approach?</label>
					<div class="helper">Select up to 3</div>
					<div class="checkbox-grid limit-3" id="methodGrid">
						<div class="checkbox-item"><input type="checkbox" value="Quantitative modeling" data-key="Quantitative modeling">Quantitative / statistical modeling</div>
						<div class="checkbox-item"><input type="checkbox" value="Machine learning" data-key="Machine learning">Machine learning / AI methods</div>
						<div class="checkbox-item"><input type="checkbox" value="Qualitative" data-key="Qualitative">Qualitative research</div>
						<div class="checkbox-item"><input type="checkbox" value="Mixed methods" data-key="Mixed methods">Mixed methods</div>
						<div class="checkbox-item"><input type="checkbox" value="Experimental" data-key="Experimental">Experimental / trial-based research</div>
						<div class="checkbox-item"><input type="checkbox" value="Observational" data-key="Observational">Observational / cohort-based research</div>
						<div class="checkbox-item"><input type="checkbox" value="Simulation" data-key="Simulation">Simulation or systems modeling</div>
						<div class="checkbox-item"><input type="checkbox" value="Other" data-key="Other" onchange="handleOther(this, 'methodologyOtherField')">Other</div>
						<div class="checkbox-item"><input type="checkbox" value="Prefer not to say" data-key="Prefer not to say">Prefer not to say</div>
					</div>
				</div>

				<div class="field" id="methodologyOtherField" style="display:none; border-bottom: none;">
					<label>Please elaborate on your methodological approach:</label>
					<input type="text" name="methodologyOtherText" placeholder="e.g., Meta-analysis, Ethnography, or Bench Science">
				</div>

				<div class="field">
					<label>Which best describes the "temporal resolution" of your research data?</label>
					<select name="temporalResolution">
						<option value="" data-key="">Select</option>
						<option value="Static / Snapshot: Data collected at a single point in time (e.g., cross-sectional surveys)" data-key="Static / Snapshot: Data collected at a single point in time (e.g., cross-sectional surveys)">Static / Snapshot: Data collected at a single point in time (e.g., cross-sectional surveys)</option>
						<option value="Episodic: Data collected at discrete intervals (e.g., annual check-ups, longitudinal clinical visits)" data-key="Episodic: Data collected at discrete intervals (e.g., annual check-ups, longitudinal clinical visits)">Episodic: Data collected at discrete intervals (e.g., annual check-ups, longitudinal clinical visits)</option>
						<option value="High-Frequency / Continuous: Data collected in near real-time (e.g., wearables, mobile sensors, IoT)" data-key="High-Frequency / Continuous: Data collected in near real-time (e.g., wearables, mobile sensors, IoT)">High-Frequency / Continuous: Data collected in near real-time (e.g., wearables, mobile sensors, IoT)</option>
						<option value="Prefer not to say" data-key="Prefer not to say">Prefer not to say</option>
					</select>
				</div>

				<div class="field">
					<label>Which types of data do you primarily use in your research?</label>
					<div class="helper">Select up to 3</div>
					<div class="checkbox-grid limit-3" id="dataGrid">
						<div class="checkbox-item"><input type="checkbox" name="dataType" value="ehr" data-key="ehr">Clinical / EHR</div>
						<div class="checkbox-item"><input type="checkbox" name="dataType" value="claims" data-key="claims">Administrative / Claims Data</div>
						<div class="checkbox-item"><input type="checkbox" name="dataType" value="survey" data-key="survey">Survey Data</div>
						<div class="checkbox-item"><input type="checkbox" name="dataType" value="omics" data-key="omics">Omics / Biological Sequences</div>
						<div class="checkbox-item"><input type="checkbox" name="dataType" value="text" data-key="text">Free-Text / NLP</div>
						<div class="checkbox-item"><input type="checkbox" name="dataType" value="imaging" data-key="imaging">Medical Imaging</div>
						<div class="checkbox-item"><input type="checkbox" name="dataType" value="geospatial" data-key="geospatial">Geospatial / Environmental Data</div>
						<div class="checkbox-item"><input type="checkbox" name="dataType" value="wearable" data-key="wearable">Wearable / mHealth Data</div>
						<div class="checkbox-item"><input type="checkbox" name="dataType" value="social" data-key="social">Social Media / Web Data</div>
						<div class="checkbox-item"><input type="checkbox" name="dataType" value="sensor" data-key="sensor">Sensor / Signal Data</div>
						<div class="checkbox-item"><input type="checkbox" value="Other" data-key="Other" onchange="handleOther(this, 'dataTypeOtherField')">Other</div>
						<div class="checkbox-item"><input type="checkbox" value="Prefer not to say" data-key="Prefer not to say">Prefer not to say</div>
					</div>
				</div>

				<div class="field" id="dataTypeOtherField" style="display:none; border-bottom: none;">
					<label>Please specify your data type:</label>
					<input type="text" name="dataTypeOtherText" placeholder="e.g., Financial records, Audio recordings, or Satellite imagery">
				</div>

				<div class="field">
					<label>Which level of data privacy describes the majority of the data used for your research?</label>
					<select name="dataPrivacy">
						<option value="" data-key="">Select</option>
						<option value="Public / Open Data: Freely accessible datasets with no identifying information" data-key="Public / Open Data: Freely accessible datasets with no identifying information">Public / Open Data: Freely accessible datasets with no identifying information</option>
						<option value="De-identified / Anonymized Data: Research data where direct and indirect identifiers have been permanently removed" data-key="De-identified / Anonymized Data: Research data where direct and indirect identifiers have been permanently removed">De-identified / Anonymized Data: Research data where direct and indirect identifiers have been permanently removed</option>
						<option value="Pseudonymized / Coded Data: Data where identifiers are replaced by codes; the 'key' exists but is held separately by a gatekeeper" data-key="Pseudonymized / Coded Data: Data where identifiers are replaced by codes; the 'key' exists but is held separately by a gatekeeper">Pseudonymized / Coded Data: Data where identifiers are replaced by codes; the 'key' exists but is held separately by a gatekeeper</option>
						<option value="Protected Health Information (PHI / PII): Identifiable patient data or 'raw' electronic health records (EHR) used within a secure clinical or institutional firewall" data-key="Protected Health Information (PHI / PII): Identifiable patient data or 'raw' electronic health records (EHR) used within a secure clinical or institutional firewall">Protected Health Information (PHI / PII): Identifiable patient data or 'raw' electronic health records (EHR) used within a secure clinical or institutional firewall</option>
						<option value="Synthetic Data: Artificially generated data that mimics the statistical properties of real patients but contains no real individual records" data-key="Synthetic Data: Artificially generated data that mimics the statistical properties of real patients but contains no real individual records">Synthetic Data: Artificially generated data that mimics the statistical properties of real patients but contains no real individual records</option>
						<option value="Federated Data: Data that stays on local servers (at the hospital or clinic)" data-key="Federated Data: Data that stays on local servers (at the hospital or clinic)">Federated Data: Data that stays on local servers (at the hospital or clinic)</option>
						<option value="Prefer not to say" data-key="Prefer not to say">Prefer not to say</option>
					</select>
				</div>

				<div class="next-area">
					<button id="nextBtn" type="button">Next</button>
				</div>
			</div>
		</div>
		<div id="customAlert" class="modal-overlay">
			<div class="modal-box">
				<h3>Incomplete Questions</h3>
				<p>It looks like you missed some questions. We've highlighted them for you.</p>
				<button id="closeAlertBtn" type="button">OK</button>
			</div>
		</div>
	</body>
	<script type="module">
		import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
		import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
		
		// --- FIREBASE CONFIG ---
		const firebaseConfig = {
			apiKey: "AIzaSyCoHmEBbmo9JB8M69O5Udu_9aVZC7ZOEPc",
			authDomain: "research-healthai-perception.firebaseapp.com",
			projectId: "research-healthai-perception",
			storageBucket: "research-healthai-perception.firebasestorage.app",
			messagingSenderId: "711118612360",
			appId: "1:711118612360:web:466d7bce64aa56954d7c3d",
			measurementId: "G-R33FXV0290"
		};
		
		const app = initializeApp(firebaseConfig);
		const db = getFirestore(app);
		
		// --- IDENTITY & TIMING ---
		const uid = localStorage.getItem('survey_uid');
		const startLocal = new Date().toLocaleString();
		const startUTC = new Date().toISOString();

		// --- CODEBOOK MAPPING (Keys must match your HTML data-key values exactly) ---
		const maps = {
			age: { "18-24": 1, "25-34": 2, "35-44": 3, "45-54": 4, "55-64": 5, "65+": 6, "Prefer not to say": 7 },
			gender: { "Woman": 1, "Man": 2, "Non-binary / gender diverse": 3, "Prefer not to say": 4 },
			region: { "Africa": 1, "East Asia": 2, "South Asia": 3, "Southeast Asia": 4, "Europe": 5, "North America": 6, "Latin America / Caribbean": 7, "Oceania": 8, "Prefer not to say": 9 },
			degree: { "Less than a bachelor's degree": 1, "Bachelor's degree (BA, BS, or equivalent)": 2, "Master's degree (MA, MS, MPH, MHS, or equivalent)": 3, "Doctoral degree - MD (or equivalent professional medical degree)": 4, "Doctoral degree - PhD or equivalent research doctorate (e.g., ScD, DrPH)": 5, "Other doctoral or professional degree (DDS, DVM, JD, PharmD, etc.)": 6, "Prefer not to say": 7 },
			income: { "Low": 1, "Lower-middle": 2, "Middle": 3, "Upper-middle": 4, "High": 5, "Prefer not to say": 6 },
			career: { "Student / Trainee": 1, "Postdoctoral researcher / Fellow": 2, "Early-career researcher or faculty": 3, "Mid-career researcher or faculty": 4, "Senior researcher or faculty": 5, "Research staff / Scientist": 6, "Industry researcher": 7, "Other": 8, "Prefer not to say": 9 },
			setting: { "Academic institution": 1, "Hospital or clinical setting": 2, "Government or public health agency": 3, "Non-profit organization": 4, "Industry": 5, "Other": 6, "Prefer not to say": 7 },
			domain: { "Population health": 1, "Public health": 2, "Epidemiology": 3, "Clinical research": 4, "Translational research": 5, "Health services research": 6, "Behavioral or social science": 7, "Biomedical informatics": 8, "Computational / Data science": 9, "Other": 10, "Prefer not to say": 11 },
			method: { "Quantitative modeling": 1, "Machine learning": 2, "Qualitative": 3, "Mixed methods": 4, "Experimental": 5, "Observational": 6, "Simulation": 7, "Other": 8, "Prefer not to say": 9 },
			temporal: { "Static / Snapshot: Data collected at a single point in time (e.g., cross-sectional surveys)": 1, "Episodic: Data collected at discrete intervals (e.g., annual check-ups, longitudinal clinical visits)": 2, "High-Frequency / Continuous: Data collected in near real-time (e.g., wearables, mobile sensors, IoT)": 3, "Prefer not to say": 4 },
			data: { "ehr": 1, "claims": 2, "survey": 3, "omics": 4, "text": 5, "imaging": 6, "geospatial": 7, "wearable": 8, "social": 9, "sensor": 10, "Other": 11, "Prefer not to say": 12 },
			privacy: { "Public / Open Data: Freely accessible datasets with no identifying information": 1, "De-identified / Anonymized Data: Research data where direct and indirect identifiers have been permanently removed": 2, "Pseudonymized / Coded Data: Data where identifiers are replaced by codes; the 'key' exists but is held separately by a gatekeeper": 3, "Protected Health Information (PHI / PII): Identifiable patient data or 'raw' electronic health records (EHR) used within a secure clinical or institutional firewall": 4, "Synthetic Data: Artificially generated data that mimics the statistical properties of real patients but contains no real individual records": 5, "Federated Data: Data that stays on local servers (at the hospital or clinic)": 6, "Prefer not to say": 7 }
		};

		// --- CORE SYNC LOGIC (TRANSLATION-PROOF) ---
		async function syncData() {
			// Helper to extract the hardcoded English key
			const getEnglishKey = (name) => {
				const el = document.querySelector(`[name="${name}"]`);
				if (!el) return "";
				if (el.tagName === "SELECT") {
					const opt = el.options[el.selectedIndex];
					return opt?.getAttribute('data-key') || opt?.value || "";
				}
				return el.value || "";
			};

			const getMultiEnglishKeys = (selector) => {
				return Array.from(document.querySelectorAll(`${selector} input:checked`))
					.map(i => i.getAttribute('data-key') || i.value);
			};

			const getText = (name) => document.querySelector(`[name="${name}"]`)?.value || "";

			const payload = {
				uid: uid,
				section_1: {
					metadata: {
						start_local: startLocal,
						start_utc: startUTC,
						last_sync: new Date().toISOString(),
						server_ts: serverTimestamp(),
						user_lang: document.documentElement.lang || 'en'
					},
					q01_age: maps.age[getEnglishKey('ageRange')] || 0,
					q02_gender: maps.gender[getEnglishKey('gender')] || 0,
					q03_region: maps.region[getEnglishKey('region')] || 0,
					q04_degree: maps.degree[getEnglishKey('highestDegree')] || 0,
					q05_income: maps.income[getEnglishKey('incomeRange')] || 0,
					q06_career: maps.career[getEnglishKey('careerStage')] || 0,
					q06_other: getText('careerStageOtherText'),
					q07_setting: maps.setting[getEnglishKey('researchSetting')] || 0,
					q07_other: getText('researchSettingOtherText'),
					q08_domains: getMultiEnglishKeys('#domainGrid').map(k => maps.domain[k] || 0),
					q08_other: getText('domainOtherText'),
					q09_methods: getMultiEnglishKeys('#methodGrid').map(k => maps.method[k] || 0),
					q09_other: getText('methodologyOtherText'),
					q10_temporal: maps.temporal[getEnglishKey('temporalResolution')] || 0,
					q11_datatypes: getMultiEnglishKeys('#dataGrid').map(k => maps.data[k] || 0),
					q11_other: getText('dataTypeOtherText'),
					q12_privacy: maps.privacy[getEnglishKey('dataPrivacy')] || 0
				},
				form_state_1: {
					// We save English keys here so restoration works regardless of current language
					ageRange: getEnglishKey('ageRange'),
					gender: getEnglishKey('gender'),
					region: getEnglishKey('region'),
					highestDegree: getEnglishKey('highestDegree'),
					incomeRange: getEnglishKey('incomeRange'),
					careerStage: getEnglishKey('careerStage'),
					careerStageOtherText: getText('careerStageOtherText'),
					researchSetting: getEnglishKey('researchSetting'),
					researchSettingOtherText: getText('researchSettingOtherText'),
					domainOtherText: getText('domainOtherText'),
					methodologyOtherText: getText('methodologyOtherText'),
					temporalResolution: getEnglishKey('temporalResolution'),
					dataTypeOtherText: getText('dataTypeOtherText'),
					dataPrivacy: getEnglishKey('dataPrivacy'),
					checked_domains: getMultiEnglishKeys('#domainGrid'),
					checked_methods: getMultiEnglishKeys('#methodGrid'),
					checked_datatypes: getMultiEnglishKeys('#dataGrid')
				}
			};

			try {
				await setDoc(doc(db, "survey_data", uid), payload, { merge: true });
				console.log("Real-time sync successful (English keys preserved).");
			} catch (e) {
				console.error("Firebase sync error: ", e);
			}
		}

		// --- RESUME LOGIC (TRANSLATION-PROOF) ---
		async function loadAndRestore() {
			try {
				const docRef = doc(db, "survey_data", uid);
				const docSnap = await getDoc(docRef);

				if (docSnap.exists() && docSnap.data().form_state_1) {
					const state = docSnap.data().form_state_1;

					// Restore Selects based on data-key
					Object.keys(state).forEach(key => {
						const el = document.querySelector(`[name="${key}"]`);
						if (el && el.tagName === "SELECT") {
							const savedEnglishVal = state[key];
							const optionToSelect = Array.from(el.options).find(opt => 
								opt.getAttribute('data-key') === savedEnglishVal || opt.value === savedEnglishVal
							);
							if (optionToSelect) el.value = optionToSelect.value;
							el.dispatchEvent(new Event('change'));
						} else if (el) {
							el.value = state[key];
						}
					});

					// Restore Checkboxes based on data-key
					const restoreChecks = (keys, gridId) => {
						if (!keys) return;
						keys.forEach(k => {
							const cb = document.querySelector(`${gridId} input[data-key="${k}"]`) || 
									document.querySelector(`${gridId} input[value="${k}"]`);
							if (cb) {
								cb.checked = true;
								cb.dispatchEvent(new Event('change'));
							}
						});
					};
					restoreChecks(state.checked_domains, '#domainGrid');
					restoreChecks(state.checked_methods, '#methodGrid');
					restoreChecks(state.checked_datatypes, '#dataGrid');
				}
			} catch (e) {
				console.error("Error during restoration:", e);
			}
			initListeners();
		}

		// This makes the function "Global" so the HTML button (onclick) can see it
		window.closeAlert = function() {
			const modal = document.getElementById('customAlert');
			if (modal) {
				modal.style.display = 'none';
			}

			// NOW apply the highlights
			const selects = ['ageRange', 'gender', 'region', 'highestDegree', 'incomeRange', 'careerStage', 'researchSetting', 'temporalResolution', 'dataPrivacy'];
			let firstMissing = null;

			selects.forEach(name => {
				const el = document.querySelector(`select[name="${name}"]`);
				if (el && (!el.value || el.value === "")) {
					const field = el.closest('.field');
					field?.classList.add('missing-field');
					if (!firstMissing) firstMissing = field;
				}
			});

			['#domainGrid', '#methodGrid', '#dataGrid'].forEach(id => {
				const container = document.querySelector(id);
				if (container && !container.querySelector('input:checked')) {
					const field = container.closest('.field');
					field?.classList.add('missing-field');
					if (!firstMissing) firstMissing = field;
				}
			});

			// Scroll to the first missing one after the modal is gone
			if (firstMissing) {
				setTimeout(() => {
					firstMissing.scrollIntoView({ behavior: 'smooth', block: 'center' });
				}, 100);
			}
		};

		function initListeners() {
			// Listener for the "OK" button in the modal
			document.getElementById('closeAlertBtn')?.addEventListener('click', window.closeAlert);

			// Existing listeners
			document.querySelectorAll('select, input').forEach(el => {
				el.addEventListener('change', syncData);
				if (el.type === 'text' || el.tagName === 'TEXTAREA') {
					el.addEventListener('input', syncData);
				}
			});
		}

		let validationAttempts = 0; // Track if they've seen the warning

		document.getElementById('nextBtn').addEventListener('click', async () => {
			// 1. Remove any old highlights first
			document.querySelectorAll('.missing-field').forEach(el => el.classList.remove('missing-field'));

			let missingAny = false;
			let firstMissing = null;

			// 2. RUN VALIDATION (Find and highlight missing fields)
			
			// Check Selects
			const selects = ['ageRange', 'gender', 'region', 'highestDegree', 'incomeRange', 'careerStage', 'researchSetting', 'temporalResolution', 'dataPrivacy'];
			selects.forEach(name => {
				const el = document.querySelector(`select[name="${name}"]`);
				if (el && (!el.value || el.value === "")) {
					const field = el.closest('.field');
					field?.classList.add('missing-field');
					missingAny = true;
					if (!firstMissing) firstMissing = field;
				}
			});

			// Check Checkbox Grids
			const grids = ['#domainGrid', '#methodGrid', '#dataGrid'];
			grids.forEach(id => {
				const container = document.querySelector(id);
				if (container && !container.querySelector('input:checked')) {
					const field = container.closest('.field');
					field?.classList.add('missing-field');
					missingAny = true;
					if (!firstMissing) firstMissing = field;
				}
			});

			// 3. SEQUENCE CONTROL
			// If fields are missing AND it's the first time they've tried to move on
			if (missingAny && validationAttempts === 0) {
				// Scroll to the first red box immediately
				firstMissing?.scrollIntoView({ behavior: 'smooth', block: 'center' });

				// Show the popup
				const modal = document.getElementById('customAlert');
				if (modal) modal.style.display = 'flex';

				validationAttempts++; // Prepare for the second click
				return; // Stop here
			}

			// 4. PROCEED
			// If no fields are missing OR it's their second click
			const btn = document.getElementById('nextBtn');
			btn.disabled = true;
			btn.innerText = "Saving...";
			await syncData();
			window.location.href = "section_2.html";
		});

		// Simple close function for the OK button
		window.closeAlert = function() {
			const modal = document.getElementById('customAlert');
			if (modal) modal.style.display = 'none';
		};

		loadAndRestore();
	</script>
	<script>
		/* UI LOGIC */
		function handleOther(element, targetId) {
			const targetField = document.getElementById(targetId);
			if (!targetField) return;
			if (element.type === 'checkbox') {
			targetField.style.display = element.checked ? "block" : "none";
			} else if (element.tagName === 'SELECT') {
			targetField.style.display = element.value === "Other" ? "block" : "none";
			}
		}
		
		function enforceLimit(container, limit) {
			const boxes = container.querySelectorAll("input[type=checkbox]");
			boxes.forEach(box => {
			box.addEventListener("change", () => {
				const checked = container.querySelectorAll("input:checked").length;
				boxes.forEach(b => {
				const item = b.closest(".checkbox-item");
				if (!b.checked && checked >= limit) {
					b.disabled = true;
					item.classList.add("disabled");
				} else {
					b.disabled = false;
					item.classList.remove("disabled");
				}
				});
			});
			});
		}
		document.querySelectorAll(".limit-3").forEach(g => enforceLimit(g, 3));
	</script>
</html>
<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Section 1 â€“ Background</title>
		<style>
			:root {
			--bg: #f8fafc;
			--card: #ffffff;
			--border: #e5e7eb;
			--text: #111827;
			--muted: #6b7280;
			--accent: #2563eb;
			--divider: #f1f5f9;
			}
			* { box-sizing: border-box; }
			body {
			margin: 0;
			background: var(--bg);
			font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
			color: var(--text);
			}
			.container {
			max-width: 760px;
			padding: 20px 16px 60px;
			margin: auto;
			}
			h1 { font-size: 1.6rem; margin-bottom: 6px; }
			p.subtle { color: var(--muted); font-size: 0.95rem; margin-bottom: 24px; }
			.card {
			background: var(--card);
			border-radius: 14px;
			padding: 20px;
			box-shadow: 0 1px 2px rgba(0,0,0,0.04);
			margin-bottom: 20px;
			}
			.card h2 { font-size: 1.15rem; margin-bottom: 20px; color: var(--accent); }
			.field {
			padding-bottom: 24px;
			margin-bottom: 24px;
			border-bottom: 2px solid var(--divider);
			}
			.field:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
			label { display: block; font-weight: 600; margin-bottom: 8px; }
			.helper { font-size: 0.85rem; color: var(--muted); margin-top: 4px; margin-bottom: 12px; }
			select, input[type="text"] {
			width: 100%;
			padding: 12px 12px;
			border-radius: 10px;
			border: 1px solid var(--border);
			font-size: 1rem;
			background: #fff;
			}
			.checkbox-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
			.checkbox-item {
			display: flex;
			align-items: center;
			padding: 12px;
			border-radius: 10px;
			border: 1px solid var(--border);
			cursor: pointer;
			background: #fff;
			}
			.checkbox-item input { margin-right: 10px; transform: scale(1.2); }
			.checkbox-item.disabled { opacity: 0.5; cursor: not-allowed; }
			.next-area { text-align: right; margin-top: 30px; }
			#nextBtn {
			background: var(--accent);
			color: white;
			border: none;
			padding: 14px 40px;
			border-radius: 10px;
			font-weight: 600;
			cursor: pointer;
			}
			.missing-field {
			border: 2px solid #ef4444 !important; /* Red border */
			background-color: #fef2f2 !important; /* Light red tint */
			padding: 10px;
			border-radius: 8px;
			}
			.modal-overlay {
			display: none; /* Hidden by default */
			position: fixed;
			top: 0; left: 0; width: 100%; height: 100%;
			background: rgba(0, 0, 0, 0.5); /* Dim the background */
			z-index: 1000;
			align-items: center;
			justify-content: center;
			}
			.modal-box {
			background: white;
			padding: 25px;
			border-radius: 12px;
			max-width: 400px;
			width: 90%;
			text-align: center;
			box-shadow: 0 10px 25px rgba(0,0,0,0.2);
			font-family: sans-serif;
			}
			.modal-box h3 { margin-top: 0; color: #333; }
			.modal-box p { color: #666; margin-bottom: 20px; }
			.modal-box button {
			background: #007bff;
			color: white;
			border: none;
			padding: 10px 30px;
			border-radius: 6px;
			cursor: pointer;
			font-size: 16px;
			}
			@media (min-width: 640px) { .checkbox-grid { grid-template-columns: 1fr 1fr; } }
		</style>
	</head>
	<body>
		<div class="container">
			<h1>Section 1</h1>
			<p class="subtle">Demographic and professional background. All questions are optional.</p>
			<div class="card">
				<h2>Basic Information</h2>
				<div class="field">
					<label>What is your age range?</label>
					<select name="ageRange">
						<option value="">Select</option>
						<option>18-24</option>
						<option>25-34</option>
						<option>35-44</option>
						<option>45-54</option>
						<option>55-64</option>
						<option>65+</option>
						<option>Prefer not to say</option>
					</select>
				</div>
				<div class="field">
					<label>How do you describe your gender identity?</label>
					<select name="gender">
						<option value="">Select</option>
						<option>Woman</option>
						<option>Man</option>
						<option>Non-binary / gender diverse</option>
						<option>Prefer not to say</option>
					</select>
				</div>
				<div class="field">
					<label>In which world region do you reside?</label>
					<select name="region">
						<option value="">Select</option>
						<option>Africa</option>
						<option>East Asia</option>
						<option>South Asia</option>
						<option>Southeast Asia</option>
						<option>Europe</option>
						<option>North America</option>
						<option>Latin America / Caribbean</option>
						<option>Oceania</option>
						<option>Prefer not to say</option>
					</select>
				</div>
				<div class="field">
					<label>What is the highest degree you have obtained?</label>
					<select name="highestDegree">
						<option value="">Select</option>
						<option>Less than a bachelor's degree</option>
						<option>Bachelor's degree (BA, BS, or equivalent)</option>
						<option>Master's degree (MA, MS, MPH, MHS, or equivalent)</option>
						<option>Doctoral degree - MD (or equivalent professional medical degree)</option>
						<option>Doctoral degree - PhD or equivalent research doctorate (e.g., ScD, DrPH)</option>
						<option>Other doctoral or professional degree (DDS, DVM, JD, PharmD, etc.)</option>
						<option>Prefer not to say</option>
					</select>
				</div>
				<div class="field">
					<label>Which income range best reflects your household's annual income relative to your local cost of living?</label>
					<select name="incomeRange">
						<option value="">Select</option>
						<option>Low</option>
						<option>Lower-middle</option>
						<option>Middle</option>
						<option>Upper-middle</option>
						<option>High</option>
						<option>Prefer not to say</option>
					</select>
				</div>
			</div>
			<div class="card">
				<h2>Research Background</h2>
				<div class="field">
					<label>What is your current career stage?</label>
					<select name="careerStage" onchange="handleOther(this, 'careerStageOther')">
						<option value="">Select</option>
						<option>Student / Trainee</option>
						<option>Postdoctoral researcher / Fellow</option>
						<option>Early-career researcher or faculty</option>
						<option>Mid-career researcher or faculty</option>
						<option>Senior researcher or faculty</option>
						<option>Research staff / Scientist</option>
						<option>Industry researcher</option>
						<option value="Other">Other</option>
						<option>Prefer not to say</option>
					</select>
				</div>
				<div class="field" id="careerStageOther" style="display:none; border-bottom: none;">
					<label>Please specify your career stage:</label>
					<input type="text" name="careerStageOtherText" placeholder="e.g., Retired/Emeritus, Independent Consultant, or Sabbatical">
				</div>
				<div class="field">
					<label>What is your primary research setting?</label>
					<select name="researchSetting" onchange="handleOther(this, 'researchSettingOther')">
						<option value="">Select</option>
						<option>Academic institution</option>
						<option>Hospital or clinical setting</option>
						<option>Government or public health agency</option>
						<option>Non-profit organization</option>
						<option>Industry</option>
						<option value="Other">Other</option>
						<option>Prefer not to say</option>
					</select>
				</div>
				<div class="field" id="researchSettingOther" style="display:none; border-bottom: none;">
					<label>Additional context on your setting:</label>
					<input type="text" name="researchSettingOtherText" placeholder="e.g., Multi-site consortium, Private Foundation, or NGO">
				</div>
				<div class="field">
					<label>Which are your primary research domains?</label>
					<div class="helper">Select up to 3</div>
					<div class="checkbox-grid limit-3" id="domainGrid">
						<div class="checkbox-item"><input type="checkbox" value="Population health">Population health</div>
						<div class="checkbox-item"><input type="checkbox" value="Public health">Public health</div>
						<div class="checkbox-item"><input type="checkbox" value="Epidemiology">Epidemiology</div>
						<div class="checkbox-item"><input type="checkbox" value="Clinical research">Clinical research</div>
						<div class="checkbox-item"><input type="checkbox" value="Translational research">Translational research</div>
						<div class="checkbox-item"><input type="checkbox" value="Health services research">Health services research</div>
						<div class="checkbox-item"><input type="checkbox" value="Behavioral or social science">Behavioral or social science</div>
						<div class="checkbox-item"><input type="checkbox" value="Biomedical informatics">Biomedical informatics</div>
						<div class="checkbox-item"><input type="checkbox" value="Computational / Data science">Computational / Data science</div>
						<div class="checkbox-item"><input type="checkbox" value="Other" onchange="handleOther(this, 'domainOtherField')">Other</div>
						<div class="checkbox-item"><input type="checkbox" value="Prefer not to say">Prefer not to say</div>
					</div>
				</div>
				<div class="field" id="domainOtherField" style="display:none; border-bottom: none;">
					<label>Please specify your research domain:</label>
					<input type="text" name="domainOtherText" placeholder="e.g., Environmental Toxins, Health Economics, or Bioethics">
				</div>
				<div class="field">
					<label>What is your primary methodological approach?</label>
					<div class="helper">Select up to 3</div>
					<div class="checkbox-grid limit-3" id="methodGrid">
						<div class="checkbox-item"><input type="checkbox" value="Quantitative modeling">Quantitative / statistical modeling</div>
						<div class="checkbox-item"><input type="checkbox" value="Machine learning">Machine learning / AI methods</div>
						<div class="checkbox-item"><input type="checkbox" value="Qualitative">Qualitative research</div>
						<div class="checkbox-item"><input type="checkbox" value="Mixed methods">Mixed methods</div>
						<div class="checkbox-item"><input type="checkbox" value="Experimental">Experimental / trial-based research</div>
						<div class="checkbox-item"><input type="checkbox" value="Observational">Observational / cohort-based research</div>
						<div class="checkbox-item"><input type="checkbox" value="Simulation">Simulation or systems modeling</div>
						<div class="checkbox-item"><input type="checkbox" value="Other" onchange="handleOther(this, 'methodologyOtherField')">Other</div>
						<div class="checkbox-item"><input type="checkbox" value="Prefer not to say">Prefer not to say</div>
					</div>
				</div>
				<div class="field" id="methodologyOtherField" style="display:none; border-bottom: none;">
					<label>Please elaborate on your methodological approach:</label>
					<input type="text" name="methodologyOtherText" placeholder="e.g., Meta-analysis, Ethnography, or Bench Science">
				</div>
				<div class="field">
					<label>Which best describes the "temporal resolution" of your research data?</label>
					<select name="temporalResolution">
						<option value="">Select</option>
						<option>Static / Snapshot: Data collected at a single point in time (e.g., cross-sectional surveys)</option>
						<option>Episodic: Data collected at discrete intervals (e.g., annual check-ups, longitudinal clinical visits)</option>
						<option>High-Frequency / Continuous: Data collected in near real-time (e.g., wearables, mobile sensors, IoT)</option>
						<option>Prefer not to say</option>
					</select>
				</div>
				<div class="field">
					<label>Which types of data do you primarily use in your research?</label>
					<div class="helper">Select up to 3</div>
					<div class="checkbox-grid limit-3" id="dataGrid">
						<div class="checkbox-item"><input type="checkbox" name="dataType" value="ehr">Clinical / EHR</div>
						<div class="checkbox-item"><input type="checkbox" name="dataType" value="claims">Administrative / Claims Data</div>
						<div class="checkbox-item"><input type="checkbox" name="dataType" value="survey">Survey Data</div>
						<div class="checkbox-item"><input type="checkbox" name="dataType" value="omics">Omics / Biological Sequences</div>
						<div class="checkbox-item"><input type="checkbox" name="dataType" value="text">Free-Text / NLP</div>
						<div class="checkbox-item"><input type="checkbox" name="dataType" value="imaging">Medical Imaging</div>
						<div class="checkbox-item"><input type="checkbox" name="dataType" value="geospatial">Geospatial / Environmental Data</div>
						<div class="checkbox-item"><input type="checkbox" name="dataType" value="wearable">Wearable / mHealth Data</div>
						<div class="checkbox-item"><input type="checkbox" name="dataType" value="social">Social Media / Web Data</div>
						<div class="checkbox-item"><input type="checkbox" name="dataType" value="sensor">Sensor / Signal Data</div>
						<div class="checkbox-item"><input type="checkbox" value="Other" onchange="handleOther(this, 'dataTypeOtherField')">Other</div>
						<div class="checkbox-item"><input type="checkbox" value="Prefer not to say">Prefer not to say</div>
					</div>
				</div>
				<div class="field" id="dataTypeOtherField" style="display:none; border-bottom: none;">
					<label>Please specify your data type:</label>
					<input type="text" name="dataTypeOtherText" placeholder="e.g., Financial records, Audio recordings, or Satellite imagery">
				</div>
				<div class="field">
					<label>Which level of data privacy describes the majority of the data used for your research?</label>
					<select name="dataPrivacy">
						<option value="">Select</option>
						<option>Public / Open Data: Freely accessible datasets with no identifying information</option>
						<option>De-identified / Anonymized Data: Research data where direct and indirect identifiers have been permanently removed</option>
						<option>Pseudonymized / Coded Data: Data where identifiers are replaced by codes; the 'key' exists but is held separately by a gatekeeper</option>
						<option>Protected Health Information (PHI / PII):  Identifiable patient data or 'raw' electronic health records (EHR) used within a secure clinical or institutional firewall</option>
						<option>Synthetic Data: Artificially generated data that mimics the statistical properties of real patients but contains no real individual records</option>
						<option>Federated Data: Data that stays on local servers (at the hospital or clinic)</option>
						<option>Prefer not to say</option>
					</select>
				</div>
				<div class="next-area">
					<button id="nextBtn" type="button">Next</button>
				</div>
			</div>
		</div>
		<div id="customAlert" class="modal-overlay">
			<div class="modal-box">
				<h3>Incomplete Questions</h3>
				<p>It looks like you missed some questions. We've highlighted them for you.</p>
				<button id="closeAlertBtn" type="button">OK</button>
			</div>
		</div>
	</body>
	<script type="module">
		import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
		import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
		
		// --- FIREBASE CONFIG (FILL THIS IN) ---
		const firebaseConfig = {
			apiKey: "AIzaSyCoHmEBbmo9JB8M69O5Udu_9aVZC7ZOEPc",
			authDomain: "research-healthai-perception.firebaseapp.com",
			projectId: "research-healthai-perception",
			storageBucket: "research-healthai-perception.firebasestorage.app",
			messagingSenderId: "711118612360",
			appId: "1:711118612360:web:466d7bce64aa56954d7c3d",
			measurementId: "G-R33FXV0290"
		};
		
		const app = initializeApp(firebaseConfig);
		const db = getFirestore(app);
		
		// --- IDENTITY & TIMING ---
		if (!localStorage.getItem('survey_uid')) {
			localStorage.setItem('survey_uid', 'usr_' + Math.random().toString(36).substr(2, 9).toUpperCase());
		}
		const uid = localStorage.getItem('survey_uid');
		
		const getFormattedDate = (date = new Date()) => {
			const pad = (num, size) => num.toString().padStart(size, '0');
			const y = date.getFullYear();
			const m = pad(date.getMonth() + 1, 2);
			const d = pad(date.getDate(), 2);
			const h = pad(date.getHours(), 2);
			const min = pad(date.getMinutes(), 2);
			const s = pad(date.getSeconds(), 2);
			const ms = pad(date.getMilliseconds(), 3);
			return `${y}-${m}-${d} ${h}:${min}:${s}.${ms}`;
		};
		
		const startLocal = getFormattedDate();
		const startUTC = new Date().toISOString().replace('T', ' ').replace('Z', ''); 
		
		// --- CODEBOOK MAPPING ---
		const maps = {
			age: { "18-24": 1, "25-34": 2, "35-44": 3, "45-54": 4, "55-64": 5, "65+": 6, "Prefer not to say": 7 },
			gender: { "Woman": 1, "Man": 2, "Non-binary / gender diverse": 3, "Prefer not to say": 4 },
			region: { "Africa": 1, "East Asia": 2, "South Asia": 3, "Southeast Asia": 4, "Europe": 5, "North America": 6, "Latin America / Caribbean": 7, "Oceania": 8, "Prefer not to say": 9 },
			degree: { "Less than a bachelor's degree": 1, "Bachelor's degree (BA, BS, or equivalent)": 2, "Master's degree (MA, MS, MPH, MHS, or equivalent)": 3, "Doctoral degree - MD (or equivalent professional medical degree)": 4, "Doctoral degree - PhD or equivalent research doctorate (e.g., ScD, DrPH)": 5, "Other doctoral or professional degree (DDS, DVM, JD, PharmD, etc.)": 6, "Prefer not to say": 7 },
			income: { "Low": 1, "Lower-middle": 2, "Middle": 3, "Upper-middle": 4, "High": 5, "Prefer not to say": 6 },
			career: { "Student / Trainee": 1, "Postdoctoral researcher / Fellow": 2, "Early-career researcher or faculty": 3, "Mid-career researcher or faculty": 4, "Senior researcher or faculty": 5, "Research staff / Scientist": 6, "Industry researcher": 7, "Other": 8, "Prefer not to say": 9 },
			setting: { "Academic institution": 1, "Hospital or clinical setting": 2, "Government or public health agency": 3, "Non-profit organization": 4, "Industry": 5, "Other": 6, "Prefer not to say": 7 },
			domain: { "Population health": 1, "Public health": 2, "Epidemiology": 3, "Clinical research": 4, "Translational research": 5, "Health services research": 6, "Behavioral or social science": 7, "Biomedical informatics": 8, "Computational / Data science": 9, "Other": 10, "Prefer not to say": 11 },
			method: { "Quantitative modeling": 1, "Machine learning": 2, "Qualitative": 3, "Mixed methods": 4, "Experimental": 5, "Observational": 6, "Simulation": 7, "Other": 8, "Prefer not to say": 9 },
			temporal: { "Static / Snapshot: Data collected at a single point in time (e.g., cross-sectional surveys)": 1, "Episodic: Data collected at discrete intervals (e.g., annual check-ups, longitudinal clinical visits)": 2, "High-Frequency / Continuous: Data collected in near real-time (e.g., wearables, mobile sensors, IoT)": 3, "Prefer not to say": 4 },
			data: { "ehr": 1, "claims": 2, "survey": 3, "omics": 4, "text": 5, "imaging": 6, "geospatial": 7, "wearable": 8, "social": 9, "sensor": 10, "Other": 11, "Prefer not to say": 12 },
			privacy: { "Public / Open Data: Freely accessible datasets with no identifying information": 1, "De-identified / Anonymized Data: Research data where direct and indirect identifiers have been permanently removed": 2, "Pseudonymized / Coded Data: Data where identifiers are replaced by codes; the 'key' exists but is held separately by a gatekeeper": 3, "Protected Health Information (PHI / PII): Identifiable patient data or 'raw' electronic health records (EHR) used within a secure clinical or institutional firewall": 4, "Synthetic Data: Artificially generated data that mimics the statistical properties of real patients but contains no real individual records": 5, "Federated Data: Data that stays on local servers (at the hospital or clinic)": 6, "Prefer not to say": 7 }
		};
		
		// --- CORE SYNC LOGIC ---
		async function syncData() {
			const getVal = (name, mapKey) => {
			const el = document.querySelector(`[name="${name}"]`);
			if (!el) return 0;
			return maps[mapKey][el.value.trim()] || 0;
			};
		
			const getMulti = (selector, mapKey) => {
			return Array.from(document.querySelectorAll(`${selector} input:checked`))
				.map(i => maps[mapKey][i.value.trim()] || 0);
			};
		
			const getText = (name) => document.querySelector(`[name="${name}"]`)?.value || "";
		
			const payload = {
			uid: uid,
			section_1: {
				metadata: {
				start_local: startLocal,
				start_utc: startUTC,
				last_sync_local: getFormattedDate(),
				server_ts: serverTimestamp()
				},
				q01_age: getVal('ageRange', 'age'),
				q02_gender: getVal('gender', 'gender'),
				q03_region: getVal('region', 'region'),
				q04_degree: getVal('highestDegree', 'degree'),
				q05_income: getVal('incomeRange', 'income'),
				q06_career: getVal('careerStage', 'career'),
				q06_other: getText('careerStageOtherText'),
				q07_setting: getVal('researchSetting', 'setting'),
				q07_other: getText('researchSettingOtherText'),
				q08_domains: getMulti('#domainGrid', 'domain'),
				q08_other: getText('domainOtherText'),
				q09_methods: getMulti('#methodGrid', 'method'),
				q09_other: getText('methodologyOtherText'),
				q10_temporal: getVal('temporalResolution', 'temporal'),
				q11_datatypes: getMulti('#dataGrid', 'data'),
				q11_other: getText('dataTypeOtherText'),
				q12_privacy: getVal('dataPrivacy', 'privacy')
			},
			// Form state allows re-populating the UI on return
			form_state_1: {
				ageRange: getText('ageRange'),
				gender: getText('gender'),
				region: getText('region'),
				highestDegree: getText('highestDegree'),
				incomeRange: getText('incomeRange'),
				careerStage: getText('careerStage'),
				careerStageOtherText: getText('careerStageOtherText'),
				researchSetting: getText('researchSetting'),
				researchSettingOtherText: getText('researchSettingOtherText'),
				domainOtherText: getText('domainOtherText'),
				methodologyOtherText: getText('methodologyOtherText'),
				temporalResolution: getText('temporalResolution'),
				dataTypeOtherText: getText('dataTypeOtherText'),
				dataPrivacy: getText('dataPrivacy'),
				checked_domains: Array.from(document.querySelectorAll('#domainGrid input:checked')).map(i => i.value),
				checked_methods: Array.from(document.querySelectorAll('#methodGrid input:checked')).map(i => i.value),
				checked_datatypes: Array.from(document.querySelectorAll('#dataGrid input:checked')).map(i => i.value)
			}
			};
		
			try {
			await setDoc(doc(db, "survey_data", uid), payload, { merge: true });
			console.log("Real-time sync successful.");
			} catch (e) {
			console.error("Firebase sync error: ", e);
			}
		}
		
		// --- RESUME LOGIC ---
		async function loadAndRestore() {
			try {
			const docRef = doc(db, "survey_data", uid);
			const docSnap = await getDoc(docRef);
		
			if (docSnap.exists() && docSnap.data().form_state_1) {
				const state = docSnap.data().form_state_1;
				console.log("Existing session found. Restoring...");
		
				// Restore Selects and Text Inputs
				Object.keys(state).forEach(key => {
				const el = document.querySelector(`[name="${key}"]`);
				if (el) {
					el.value = state[key];
					// Manually trigger change to show 'Other' fields via handleOther()
					el.dispatchEvent(new Event('change'));
				}
				});
		
				// Restore Checkboxes
				const restoreChecks = (values, gridId) => {
				if (!values) return;
				values.forEach(val => {
					const cb = document.querySelector(`${gridId} input[value="${val}"]`);
					if (cb) {
					cb.checked = true;
					cb.dispatchEvent(new Event('change')); // Triggers limit-3 logic
					}
				});
				};
				restoreChecks(state.checked_domains, '#domainGrid');
				restoreChecks(state.checked_methods, '#methodGrid');
				restoreChecks(state.checked_datatypes, '#dataGrid');
			}
			} catch (e) {
			console.error("Error during restoration:", e);
			}
			
			// Initialize Real-time Listeners AFTER restoration
			initListeners();
		}
		
		// This makes the function "Global" so the HTML button can see it
		window.closeAlert = function() {
		    const modal = document.getElementById('customAlert');
		    if (modal) {
		        modal.style.display = 'none';
		    }
		};

		function initListeners() {
			document.getElementById('closeAlertBtn')?.addEventListener('click', window.closeAlert);
			document.querySelectorAll('select, input').forEach(el => {
				el.addEventListener('change', syncData);
				if (el.type === 'text' || el.tagName === 'TEXTAREA') {
					el.addEventListener('input', syncData);
				}
			});
		}
		
		// --- FINAL SUBMIT & VALIDATION ---
		let validationAttempts = 0;
		document.getElementById('nextBtn').addEventListener('click', async () => {
			document.querySelectorAll('.missing-field').forEach(el => el.classList.remove('missing-field'));
		
			const singleSelects = ['ageRange', 'gender', 'region', 'highestDegree', 'incomeRange', 'careerStage', 'researchSetting', 'temporalResolution', 'dataPrivacy'];
			let missingAny = false;
		
			singleSelects.forEach(name => {
			const el = document.querySelector(`[name="${name}"]`);
			if (!el || !el.value) {
				el?.closest('div')?.classList.add('missing-field');
				missingAny = true;
			}
			});
		
			['#domainGrid', '#methodGrid', '#dataGrid'].forEach(id => {
			if (document.querySelectorAll(`${id} input:checked`).length === 0) {
				document.querySelector(id).closest('div')?.classList.add('missing-field');
				missingAny = true;
			}
			});
		
			if (missingAny && validationAttempts === 0) {
			document.getElementById('customAlert').style.display = 'flex';
		
			validationAttempts++;
			document.querySelector('.missing-field')?.scrollIntoView({ behavior: 'smooth', block: 'center' });
			return;
			}
		
			const btn = document.getElementById('nextBtn');
			btn.disabled = true;
			btn.innerText = "Saving...";
			await syncData();
			window.location.href = "section_2.html";
		});
		
		// Start the process
		loadAndRestore();
	</script>
	<script>
		/* UI LOGIC */
		function handleOther(element, targetId) {
			const targetField = document.getElementById(targetId);
			if (!targetField) return;
			if (element.type === 'checkbox') {
			targetField.style.display = element.checked ? "block" : "none";
			} else if (element.tagName === 'SELECT') {
			targetField.style.display = element.value === "Other" ? "block" : "none";
			}
		}
		
		function enforceLimit(container, limit) {
			const boxes = container.querySelectorAll("input[type=checkbox]");
			boxes.forEach(box => {
			box.addEventListener("change", () => {
				const checked = container.querySelectorAll("input:checked").length;
				boxes.forEach(b => {
				const item = b.closest(".checkbox-item");
				if (!b.checked && checked >= limit) {
					b.disabled = true;
					item.classList.add("disabled");
				} else {
					b.disabled = false;
					item.classList.remove("disabled");
				}
				});
			});
			});
		}
		document.querySelectorAll(".limit-3").forEach(g => enforceLimit(g, 3));
	</script>
</html>